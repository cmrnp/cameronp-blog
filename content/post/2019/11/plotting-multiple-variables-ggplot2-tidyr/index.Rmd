---
title: Plotting multiple variables at once using ggplot2 and tidyr
author: Cameron Patrick
date: '2019-11-26'
draft: true
slug: plotting-multiple-variables-ggplot2-tidyr
categories: []
tags:
  - r
  - ggplot2
  - tidyr
  - graphs
subtitle: ''
summary: ''
lastmod: '2019-11-26T11:00:00+11:00'
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
---

In exploratory data analysis, it's common to want to make similar
plots of a number of variables at once. For example, a randomised trial may
look at several outcomes, or a survey may have a large number of items. Some
packages---for example, Minitab---make it easy to put several variables on the
same plot with an option for "multiple Ys". Here are a couple of ways of achieving
the same thing using R and `ggplot2`.

```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, dpi = 144, fig.retina = 2)

library(tidyverse)
theme_set(theme_bw() +
            theme(panel.grid.minor.x = element_blank(),
                  panel.grid.minor.y = element_blank()))
```

```{r simulate-survey, include = FALSE}
likert_distributions <- list(
  group = c(0.5, 0.5, 0, 0, 0),
  Q1 = c(0.01, 0.05, 0.09, 0.55, 0.30),
  Q2 = c(0.14, 0.45, 0.10, 0.22, 0.09),
  Q3 = c(0.01, 0.01, 0.01, 0.39, 0.58),
  Q4 = c(0.47, 0.32, 0.06, 0.14, 0.01),
  Q5 = c(0.14, 0.33, 0.11, 0.36, 0.06),
  Q6 = c(0.17, 0.21, 0.40, 0.13, 0.09)
)
n_samples <- 300
set.seed(12345)
survey_data <- map_dfc(likert_distributions, 
                       ~ sample(1:5, n_samples, replace = TRUE, prob = .))
```


## Pivoting longer: turning your variables into rows

`ggplot2` doesn't provide an easy facility to plot multiple variables
at once because this is usually a sign that [your data is not "tidy"](https://vita.had.co.nz/papers/tidy-data.pdf). For example, if you want
to plot two variables on a graph as points with different colours, the two
columns probably really represent the same variable, and there is a hidden
grouping factor which distinguishes the data points you want to colour differently.
The usual answer in this scenario is that you
should restructure your data before plotting it. As a bonus, it will probably be
easier to analyse that way too.

It is less obviously true that if you want to split a plot into panels (or
facets, in `ggplot2`-speak) then the different panels must represent an underlying grouping factor, but as far as `gglot2` is concerned, the same logic applies:
you must plot a single response variable, with a grouping variable to indicate
which panel the data should be plotted in.
The best structure for your data depends
on what you're trying to do with it, and in this situation, even if your data
is in the right form for modelling, it may not be right for the plots you want
to make.

Fortunately, this kind of restructuring is straightforward using the `tidyr`
package and the `pivot_longer()` function. In this example, I'm going to look at some
mocked-up survey data, with six questions stored in variables `Q1` through `Q6`.
The original data frame looks like this:

```{r show-original-data}
glimpse(survey_data)
```

You can convert this into a
longer data frame where the question number is stored in one column and the
response is stored in a separate column:

```{r pivot-longer-example}
longer_data <- survey_data %>%
  pivot_longer(Q1:Q6, names_to = "question", values_to = "response")
glimpse(longer_data)
```

You don't even need to store the 'long form' data as a separate variable; it's
possible to pipe data straight into `ggplot2`. Here I use the `facet_wrap()`
function to plot each question in a separate panel, so we can see the distribution
of all of the questions at once:

```{r panel-plot, fig.width = 5, fig.height = 3}
survey_data %>%
  pivot_longer(Q1:Q6, names_to = "question", values_to = "response") %>%
  ggplot(aes(x = response)) +
  geom_bar() +
  facet_wrap(vars(question), ncol = 3) +
  labs(x = "Response", y = "Number of respondents")
```

By default, R will sort the order of factors alphabetically. This isn't always
what you want in this situation---often the order of the variables in your data
frame has some meaning to it. The `fct_inorder()` function allows you to reorder
levels of a factor in the order of first appearance in the file. If you use that
with the column produced by `pivot_longer()`, the factor will be ordered by the
order of the columns in the original data frame.

## Making multiple plots and combining them with grid.arrange
